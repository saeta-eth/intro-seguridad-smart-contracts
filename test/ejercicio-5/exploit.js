const { expect } = require("chai");
const { ethers } = require("hardhat");

describe("Ejercicio 5", function () {

  let deployer, atacante;

  beforeEach(async function () {

    [deployer, atacante] = await ethers.getSigners();

    // Se deploya el contrato
    const VaultV3 = await ethers.getContractFactory("VaultV3", deployer);
    this.vault = await VaultV3.deploy();

    // Se depositan 100 ETH en el contrato
    await this.vault.deposit({ value: ethers.utils.parseEther('100') });

    expect(
      await this.vault.deposits(deployer.address)
    ).to.eq(ethers.utils.parseEther('100'));

    expect(
      await ethers.provider.getBalance(this.vault.address)
    ).to.eq(ethers.utils.parseEther('100'));
  });

  it("Ataque", async function () {
    const VaultV3Attacker = await ethers.getContractFactory("VaultV3Attacker", atacante);
    this.attacker = await VaultV3Attacker.deploy(this.vault.address);

    await this.attacker.attack({
      value: ethers.utils.parseEther('10'),
    });

    // El contratro atacante tiene los 110 eth.
    expect(
      await ethers.provider.getBalance(this.attacker.address)
    ).to.eq(ethers.utils.parseEther('110'))
  });

  afterEach(async function() {
    expect(
      await ethers.provider.getBalance(this.vault.address)
    ).to.eq('0');
  });
});
